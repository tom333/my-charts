# Nom du chart
nameOverride: ""
fullnameOverride: ""

# PostgreSQL configuration
postgresql:
  image:
    repository: bitnamilegacy/postgresql
  auth:
    username: mlflow
    password: mlflow
    database: mlflow
    postgresPassword: postgres
  primary:
    persistence:
      enabled: true
      size: 10Gi


# RustFS S3 storage configuration (standalone mode)
rustfs:
  replicaCount: 1
  
  # S3 configuration
  s3:
    region: "rustfs"
    endpoint: "s3.tgu.ovh"
  
  # Persistence
  persistence:
    enabled: true
    size: 10Gi
    storageClass: null
  
  # Ingress configuration
  ingress:
    enabled: true
    className: nginx
    nginxAnnotations:
      nginx.ingress.kubernetes.io/affinity: cookie
      nginx.ingress.kubernetes.io/proxy-body-size: "0"
      nginx.ingress.kubernetes.io/session-cookie-expires: "3600"
      nginx.ingress.kubernetes.io/session-cookie-hash: sha1
      nginx.ingress.kubernetes.io/session-cookie-max-age: "3600"
      nginx.ingress.kubernetes.io/session-cookie-name: rustfs
      cert-manager.io/cluster-issuer: "letsencrypt-prod"
    hosts:
      - host: s3.tgu.ovh
        paths:
          - path: /
            pathType: Prefix
    tls:
      enabled: true
      secretName: rustfs-s3-tls

# MLflow configuration
mlflow:
  # Nombre de réplicas
  replicaCount: 1
  
  # Image MLflow
  # IMPORTANT: L'image officielle ne contient pas le driver PostgreSQL.
  # Vous devez construire une image personnalisée avec psycopg2-binary installé.
  # Voir charts/datalab/docker/README.md pour les instructions.
  image:
    repository: ghcr.io/tom333/mlflow-postgresql
    tag: latest
    pullPolicy: IfNotPresent
  
  imagePullSecrets: []
  
  # Configuration du backend store (PostgreSQL)
  backendStore:
    uri: "postgresql://mlflow:mlflow@lab-postgresql:5432/mlflow"
  
  # Configuration de l'artifact store (RustFS)
  artifactsDestination: "s3://mlflow/artifacts"
  
  # Configuration S3/RustFS
  s3:
    region: "rustfs"
    accessKeyId: "rustfsadmin"
    secretAccessKey: "rustfsadmin"
  
  # Hosts autorisés pour éviter les erreurs "Invalid Host header"
  # Mettre le domaine configuré dans ingress.hosts (ou "*" pour tout autoriser)
  allowedHosts: "mlflow.tgu.ovh"
  
  # Variables d'environnement supplémentaires
  extraEnvs: []
  
  # Arguments supplémentaires pour la commande mlflow server
  extraArgs: []
  
  # Service configuration
  service:
    type: ClusterIP
    port: 5000
  
  # Probes
  livenessProbe:
    enabled: true
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  
  readinessProbe:
    enabled: true
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
  
  # Resources
  resources:
    limits:
      cpu: 1000m
      memory: 1Gi
    requests:
      cpu: 100m
      memory: 256Mi
  
  # Node selector
  nodeSelector: {}
  
  # Tolerations
  tolerations: []
  
  # Affinity
  affinity: {}

# mysql:
#   image:
#     repository: bitnamilegacy/mysql
#   auth:
#     database: zenml
#     username: zenml
#     password: zenml
#     rootPassword: password

# zenml:
#   zenml:
#     database:
#       url: "mysql://zenml:zenml@lab-mysql.ia-lab.svc.cluster.local:3306/zenml"
#     ingress:
#       enabled: true
#       annotations:
#         cert-manager.io/cluster-issuer: "letsencrypt-prod"
#       host: zenml.tgu.ovh
#       tls:
#         enabled: true
#         secretName: zenml-tls-certs

# Custom Ingress for MLflow with TLS support
ingress:
  enabled: true
  className: "nginx"
  annotations:
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    nginx.ingress.kubernetes.io/proxy-body-size: "512m"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "180"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
  hosts:
    - host: mlflow.tgu.ovh
      paths:
        - path: /
          pathType: Prefix
  tls:
    - secretName: mlflow-tls
      hosts:
        - mlflow.tgu.ovh

# # Persistence configuration
# persistence:
#  size: 10Gi
#  accessMode: ReadWriteOnce
